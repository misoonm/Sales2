<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نقطة البيع - نظام إدارة المحلات التجارية</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://unpkg.com/@zxing/library@0.19.1"></script>
    <style>
        /* نفس الأنماط السابقة */
        :root {
            --primary-color: #4e73df;
            --primary-light: #7a9ff7;
            --primary-dark: #2a4b9e;
            --secondary-color: #1cc88a;
            --secondary-light: #4adca8;
            --secondary-dark: #138a5e;
            --warning-color: #f6c23e;
            --warning-light: #f9d37a;
            --warning-dark: #c99a1a;
            --danger-color: #e74a3b;
            --danger-light: #ef7e73;
            --danger-dark: #b21f15;
            --dark-color: #5a5c69;
            --light-color: #f8f9fc;
            --gray-100: #f8f9fc;
            --gray-200: #eaecf4;
            --gray-300: #dddfeb;
            --gray-400: #d1d3e2;
            --gray-500: #b7b9cc;
            --gray-600: #858796;
            --gray-700: #6e707e;
            --gray-800: #5a5c69;
            --gray-900: #3a3b45;
            --transition: all 0.3s ease;
            --shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            --shadow-hover: 0 0.5rem 2rem 0 rgba(58, 59, 69, 0.2);
            --radius: 0.75rem;
            --navbar-height: 70px;
        }

        [data-theme="dark"] {
            --primary-color: #4e73df;
            --primary-light: #7a9ff7;
            --primary-dark: #2a4b9e;
            --secondary-color: #1cc88a;
            --secondary-light: #4adca8;
            --secondary-dark: #138a5e;
            --warning-color: #f6c23e;
            --warning-light: #f9d37a;
            --warning-dark: #c99a1a;
            --danger-color: #e74a3b;
            --danger-light: #ef7e73;
            --danger-dark: #b21f15;
            --dark-color: #d1d3e2;
            --light-color: #2a2b3d;
            --gray-100: #2a2b3d;
            --gray-200: #353646;
            --gray-300: #3f4051;
            --gray-400: #4a4b5c;
            --gray-500: #5a5c69;
            --gray-600: #858796;
            --gray-700: #b7b9cc;
            --gray-800: #d1d3e2;
            --gray-900: #eaecf4;
        }

        body {
            font-family: 'Cairo', 'Tahoma', sans-serif;
            background-color: var(--light-color);
            color: var(--gray-900);
            transition: var(--transition);
            padding-top: var(--navbar-height);
            min-height: 100vh;
        }

        .navbar-top {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            height: var(--navbar-height);
            box-shadow: var(--shadow);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1030;
            transition: var(--transition);
        }

        .navbar-top .container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 100%;
        }

        .navbar-bottom {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: var(--gray-100);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1020;
            border-top: 1px solid var(--gray-300);
            transition: var(--transition);
        }

        .nav-item-bottom {
            text-align: center;
            padding: 12px 0;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            color: var(--gray-600);
            text-decoration: none;
        }

        .nav-item-bottom:hover, .nav-item-bottom.active {
            color: var(--primary-color);
        }

        .nav-item-bottom.active::before {
            content: '';
            position: absolute;
            top: 0;
            right: 50%;
            transform: translateX(50%);
            width: 70%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 0 0 3px 3px;
        }

        .nav-item-bottom i {
            font-size: 1.25rem;
            display: block;
            margin: 0 auto 5px;
            transition: var(--transition);
        }

        .nav-item-bottom span {
            font-size: 0.75rem;
            display: block;
        }

        .card {
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            transition: var(--transition);
            border: none;
            background-color: var(--gray-100);
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: var(--radius) var(--radius) 0 0 !important;
        }

        .search-box {
            margin-bottom: 20px;
            position: relative;
        }

        .search-box .form-control {
            border-radius: 50px;
            padding-right: 45px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--gray-300);
            transition: var(--transition);
        }

        .search-box .form-control:focus {
            box-shadow: 0 2px 10px rgba(78, 115, 223, 0.2);
            border-color: var(--primary-light);
        }

        .search-box .btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-color);
            border: none;
            transition: var(--transition);
        }

        .search-box .btn:hover {
            background: var(--primary-dark);
        }

        .btn {
            border-radius: var(--radius);
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn i {
            margin-left: 5px;
        }

        .btn-primary {
            background: linear-gradient(to right, var(--primary-color), var(--primary-light));
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(to right, var(--primary-dark), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(78, 115, 223, 0.3);
        }

        .btn-success {
            background: linear-gradient(to right, var(--secondary-color), var(--secondary-light));
            border: none;
        }

        .btn-success:hover {
            background: linear-gradient(to right, var(--secondary-dark), var(--secondary-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(28, 200, 138, 0.3);
        }

        .btn-danger {
            background: linear-gradient(to right, var(--danger-color), var(--danger-light));
            border: none;
        }

        .btn-danger:hover {
            background: linear-gradient(to right, var(--danger-dark), var(--danger-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 74, 59, 0.3);
        }

        .product-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .product-image:hover {
            transform: scale(1.1);
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-300);
            transition: var(--transition);
        }

        .cart-item:hover {
            background-color: var(--gray-200);
            border-radius: var(--radius);
            padding: 12px;
        }

        .cart-quantity {
            display: flex;
            align-items: center;
        }

        .discount-input {
            max-width: 100px;
            display: inline-block;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .barcode-scanner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .barcode-scanner.active {
            opacity: 1;
            visibility: visible;
        }

        .barcode-scanner video {
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }

        .barcode-scanner .scanner-controls {
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .product-image {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="navbar-top">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-4">
                    <span id="store-name">متجري</span>
                </div>
                <div class="col-4 text-center">
                    <span id="current-date"></span>
                </div>
                <div class="col-4 text-end">
                    <span>مرحباً، مدير النظام</span>
                    <button class="btn btn-outline-light btn-sm ms-2" id="logout-btn">
                        <i class="bi bi-box-arrow-right"></i> تسجيل الخروج
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <h2 class="mb-4">نقطة البيع</h2>
        
        <div class="row">
            <div class="col-md-8">
                <div class="input-group search-box">
                    <input type="text" class="form-control" placeholder="بحث عن منتج..." id="pos-product-search">
                    <button class="btn btn-primary" type="button" id="barcode-btn">
                        <i class="bi bi-upc-scan"></i> مسح الباركود
                    </button>
                </div>
                

                <div class="card mt-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-white">سلة المشتريات</h6>
                    </div>
                    <div class="card-body">
                        <div id="cart-items">
                            <p class="text-center text-muted" id="empty-cart-message">السلة فارغة</p>
                        </div>
                        
                        <div class="mt-3" id="discount-section">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>الخصم:</span>
                                <div>
                                    <input type="number" class="form-control discount-input" id="discount-value" min="0" value="0">
                                    <select class="form-select discount-input" id="discount-type">
                                        <option value="percent">%</option>
                                        <option value="fixed">ريال</option>
                                    </select>
                                    <button class="btn btn-sm btn-outline-primary" id="apply-discount-btn">تطبيق</button>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>قيمة الخصم:</span>
                                <span id="discount-amount">0 ريال</span>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <button class="btn btn-danger" id="clear-cart-btn">
                                <i class="bi bi-trash"></i> مسح السلة
                            </button>
                            <div>
                                <span class="fw-bold">الإجمالي: </span>
                                <span id="cart-total">0 ريال</span>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label">طريقة الدفع:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="cashPayment" value="نقدي" checked>
                                <label class="form-check-label" for="cashPayment">نقدي</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="cardPayment" value="بطاقة">
                                <label class="form-check-label" for="cardPayment">بطاقة</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="transferPayment" value="تحويل">
                                <label class="form-check-label" for="transferPayment">تحويل</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="creditPayment" value="آجل">
                                <label class="form-check-label" for="creditPayment">آجل (دين)</label>
                            </div>
                        </div>
                        
                        <div class="mt-3" id="customer-section" style="display: none;">
                            <label for="customer-name" class="form-label">اسم العميل (للبيع الآجل):</label>
                            <input type="text" class="form-control" id="customer-name">
                        </div>
                        
                        <button class="btn btn-success btn-lg w-100 mt-3" id="complete-sale-btn">
                            <i class="bi bi-check-circle"></i> إتمام البيع
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">المنتجات المتاحة</h6>
                    </div>
                    <div class="card-body" id="available-products" style="max-height: 70vh; overflow-y: auto;">
                        <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <nav class="navbar-bottom">
        <div class="container">
            <div class="row">
                <div class="col-2 nav-item-bottom" onclick="window.location.href='dashboard.html'">
                    <i class="bi bi-speedometer2"></i>
                    <span>لوحة التحكم</span>
                </div>
                <div class="col-2 nav-item-bottom" onclick="window.location.href='products.html'">
                    <i class="bi bi-box-seam"></i>
                    <span>المنتجات</span>
                </div>
                <div class="col-2 nav-item-bottom active">
                    <i class="bi bi-cash-coin"></i>
                    <span>نقطة البيع</span>
                </div>
                <div class="col-2 nav-item-bottom" onclick="window.location.href='reports.html'">
                    <i class="bi bi-graph-up"></i>
                    <span>التقارير</span>
                </div>
                <div class="col-2 nav-item-bottom" onclick="window.location.href='suppliers.html'">
                    <i class="bi bi-truck"></i>
                    <span>الموردين</span>
                </div>
                <div class="col-2 nav-item-bottom" onclick="window.location.href='credit.html'">
                    <i class="bi bi-credit-card"></i>
                    <span>آجل</span>
                </div>      
            </div>
        </div>
    </nav>

    <!-- ماسح الباركود -->
    <div class="barcode-scanner" id="barcode-scanner">
        <video id="barcode-video"></video>
        <div class="scanner-controls">
            <button class="btn btn-danger" id="close-scanner-btn">إغلاق الماسح</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="database.js"></script>
    <script>
        // التحقق من تسجيل الدخول
        const currentUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
        if (!currentUser) {
            window.location.href = 'index.html';
        }

        // تهيئة قاعدة البيانات
        let dbInstance;
        async function initDatabase() {
            try {
                await initDatabase();
                dbInstance = db;
                console.log('تم تهيئة قاعدة البيانات بنجاح');
                
                // تحميل المنتجات المتاحة
                loadAvailableProducts();
                
                // تحميل إعدادات المتجر
                const settings = await dbInstance.getSettings();
                document.getElementById('store-name').textContent = settings.storeName || 'متجري';
            } catch (error) {
                console.error('خطأ في تهيئة قاعدة البيانات:', error);
            }
        }

        // تهيئة التاريخ والوقت
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('ar-YE', options);
        }
        
        updateDateTime();
        setInterval(updateDateTime, 60000);

        // تسجيل الخروج
        document.getElementById('logout-btn').addEventListener('click', function() {
            localStorage.removeItem('currentUser');
            sessionStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        });

        // تحميل المنتجات المتاحة
        async function loadAvailableProducts() {
            try {
                const products = await dbInstance.getProducts();
                const availableProductsDiv = document.getElementById('available-products');
                availableProductsDiv.innerHTML = '';
                
                if (products.length === 0) {
                    availableProductsDiv.innerHTML = '<p class="text-center text-muted">لا توجد منتجات متاحة</p>';
                    return;
                }
                
                products.forEach(product => {
                    if (product.quantity > 0) {
                        const productCard = document.createElement('div');
                        productCard.className = 'product-item cursor-pointer';
                        productCard.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <img src="${product.image || 'https://via.placeholder.com/40'}" class="product-image me-2" alt="${product.name}">
                                    <div>
                                        <h6 class="mb-0">${product.name}</h6>
                                        <small class="text-muted">${product.price.toLocaleString()} ريال</small>
                                    </div>
                                </div>
                                <span class="badge bg-primary">${product.quantity} متوفر</span>
                            </div>
                        `;
                        
                        productCard.addEventListener('click', function() {
                            addToCart(product);
                        });
                        
                        availableProductsDiv.appendChild(productCard);
                    }
                });
            } catch (error) {
                console.error('خطأ في تحميل المنتجات:', error);
            }
        }

        // إضافة منتج إلى السلة
        function addToCart(product) {
            const cartItems = document.getElementById('cart-items');
            const emptyCartMessage = document.getElementById('empty-cart-message');
            
            // إخفاء رسالة السلة الفارغة إذا كانت مرئية
            if (emptyCartMessage.style.display !== 'none') {
                emptyCartMessage.style.display = 'none';
            }
            
            // التحقق إذا كان المنتج موجوداً بالفعل في السلة
            const existingItem = document.querySelector(`.cart-item[data-id="${product.id}"]`);
            
            if (existingItem) {
                // زيادة الكمية إذا كان المنتج موجوداً
                const quantityElement = existingItem.querySelector('.item-quantity');
                let quantity = parseInt(quantityElement.textContent);
                
                if (quantity < product.quantity) {
                    quantity++;
                    quantityElement.textContent = quantity;
                    
                    // تحديث السعر الإجمالي لهذا المنتج
                    const totalElement = existingItem.querySelector('.item-total');
                    totalElement.textContent = (quantity * product.price).toLocaleString() + ' ريال';
                } else {
                    alert('لا يمكن إضافة كمية أكثر من المتاحة في المخزون');
                }
            } else {
                // إضافة منتج جديد إلى السلة
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.setAttribute('data-id', product.id);
                cartItem.innerHTML = `
                    <div>
                        <h6 class="mb-0">${product.name}</h6>
                        <small class="text-muted">${product.price.toLocaleString()} ريال للوحدة</small>
                    </div>
                    <div class="cart-quantity">
                        <button class="btn btn-sm btn-outline-secondary decrease-btn">-</button>
                        <span class="mx-2 item-quantity">1</span>
                        <button class="btn btn-sm btn-outline-secondary increase-btn">+</button>
                        <span class="mx-3 item-total">${product.price.toLocaleString()} ريال</span>
                        <button class="btn btn-sm btn-danger remove-btn">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                `;
                
                // إضافة معالجات الأحداث للأزرار
                const decreaseBtn = cartItem.querySelector('.decrease-btn');
                const increaseBtn = cartItem.querySelector('.increase-btn');
                const removeBtn = cartItem.querySelector('.remove-btn');
                
                decreaseBtn.addEventListener('click', function() {
                    const quantityElement = cartItem.querySelector('.item-quantity');
                    let quantity = parseInt(quantityElement.textContent);
                    
                    if (quantity > 1) {
                        quantity--;
                        quantityElement.textContent = quantity;
                        
                        const totalElement = cartItem.querySelector('.item-total');
                        totalElement.textContent = (quantity * product.price).toLocaleString() + ' ريال';
                        
                        updateCartTotal();
                    }
                });
                
                increaseBtn.addEventListener('click', function() {
                    const quantityElement = cartItem.querySelector('.item-quantity');
                    let quantity = parseInt(quantityElement.textContent);
                    
                    if (quantity < product.quantity) {
                        quantity++;
                        quantityElement.textContent = quantity;
                        
                        const totalElement = cartItem.querySelector('.item-total');
                        totalElement.textContent = (quantity * product.price).toLocaleString() + ' ريال';
                        
                        updateCartTotal();
                    } else {
                        alert('لا يمكن إضافة كمية أكثر من المتاحة في المخزون');
                    }
                });
                
                removeBtn.addEventListener('click', function() {
                    cartItem.remove();
                    updateCartTotal();
                    
                    // إذا كانت السلة فارغة، عرض الرسالة
                    if (document.querySelectorAll('.cart-item').length === 0) {
                        emptyCartMessage.style.display = 'block';
                    }
                });
                
                cartItems.appendChild(cartItem);
            }
            
            updateCartTotal();
        }

        // تحديث الإجمالي في السلة
        function updateCartTotal() {
            const cartItems = document.querySelectorAll('.cart-item');
            let total = 0;
            
            cartItems.forEach(item => {
                const totalText = item.querySelector('.item-total').textContent;
                const itemTotal = parseFloat(totalText.replace(/[^\d.]/g, ''));
                total += itemTotal;
            });
            
            // تطبيق الخصم إذا كان موجوداً
            const discountAmount = parseFloat(document.getElementById('discount-amount').textContent.replace(/[^\d.]/g, '') || 0);
            const finalTotal = total - discountAmount;
            
            document.getElementById('cart-total').textContent = finalTotal.toLocaleString() + ' ريال';
        }

        // تطبيق الخصم على السلة
        document.getElementById('apply-discount-btn').addEventListener('click', function() {
            const discountValue = parseFloat(document.getElementById('discount-value').value);
            const discountType = document.getElementById('discount-type').value;
            
            if (isNaN(discountValue) || discountValue < 0) {
                alert('يرجى إدخال قيمة خصم صحيحة');
                return;
            }
            
            const cartItems = document.querySelectorAll('.cart-item');
            let total = 0;
            
            cartItems.forEach(item => {
                const totalText = item.querySelector('.item-total').textContent;
                const itemTotal = parseFloat(totalText.replace(/[^\d.]/g, ''));
                total += itemTotal;
            });
            
            let discountAmount = 0;
            
            if (discountType === 'percent') {
                // خصم بنسبة مئوية
                discountAmount = total * (discountValue / 100);
            } else {
                // خصم بقيمة ثابتة
                discountAmount = discountValue;
            }
            
            // التأكد من أن الخصم لا يتجاوز الإجمالي
            if (discountAmount > total) {
                discountAmount = total;
            }
            
            document.getElementById('discount-amount').textContent = discountAmount.toLocaleString() + ' ريال';
            updateCartTotal();
        });

        // مسح السلة
        document.getElementById('clear-cart-btn').addEventListener('click', function() {
            if (!confirm('هل أنت متأكد من مسح السلة؟')) {
                return;
            }
            
            const cartItems = document.getElementById('cart-items');
            cartItems.innerHTML = '';
            
            document.getElementById('empty-cart-message').style.display = 'block';
            document.getElementById('cart-total').textContent = '0 ريال';
            document.getElementById('discount-value').value = '0';
            document.getElementById('discount-amount').textContent = '0 ريال';
        });

        // إظهار/إخفاء قسم العميل للبيع الآجل
        document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('customer-section').style.display = 
                    this.value === 'آجل' ? 'block' : 'none';
            });
        });

        // إتمام عملية البيع
        document.getElementById('complete-sale-btn').addEventListener('click', async function() {
            const cartItems = document.querySelectorAll('.cart-item');
            
            if (cartItems.length === 0) {
                alert('السلة فارغة، يرجى إضافة منتجات أولاً');
                return;
            }
            
            // الحصول على طريقة الدفع
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            // الحصول على اسم العميل إذا كانت طريقة الدفع آجلة
            const customerName = paymentMethod === 'آجل' ? document.getElementById('customer-name').value : null;
            
            if (paymentMethod === 'آجل' && !customerName) {
                alert('يرجى إدخال اسم العميل للبيع الآجل');
                return;
            }
            
            // الحصول على قيمة الخصم
            const discountAmount = parseFloat(document.getElementById('discount-amount').textContent.replace(/[^\d.]/g, '') || 0);
            
            // تجهيز بيانات البيع
            const sale = {
                invoiceNumber: 'INV-' + Date.now(),
                date: new Date().toLocaleDateString('en-CA'),
                items: [],
                total: parseFloat(document.getElementById('cart-total').textContent.replace(/[^\d.]/g, '')),
                discount: discountAmount,
                paymentMethod,
                customerName,
                employee: 'مدير النظام', // يمكن تغيير هذا حسب المستخدم المسجل دخوله
                createdAt: new Date()
            };
            
            // تحديث المخزون وإعداد عناصر البيع
            let hasError = false;
            
            for (const item of cartItems) {
                const productId = parseInt(item.getAttribute('data-id'));
                const quantity = parseInt(item.querySelector('.item-quantity').textContent);
                
                try {
                    const product = await dbInstance.get('products', productId);
                    
                    if (!product) {
                        alert(`المنتج غير موجود: ${productId}`);
                        hasError = true;
                        break;
                    }
                    
                    if (product.quantity < quantity) {
                        alert(`الكمية المطلوبة غير متوفرة للمنتج: ${product.name}`);
                        hasError = true;
                        break;
                    }
                    
                    // تحديث المخزون
                    product.quantity -= quantity;
                    await dbInstance.update('products', product);
                    
                    // إضافة إلى عناصر البيع
                    sale.items.push({
                        productId,
                        name: product.name,
                        price: product.price,
                        quantity
                    });
                } catch (error) {
                    console.error('خطأ في تحديث المنتج:', error);
                    hasError = true;
                    break;
                }
            }
            
            if (hasError) {
                alert('حدث خطأ أثناء معالجة البيع، يرجى المحاولة مرة أخرى');
                return;
            }
            
            try {
                if (paymentMethod === 'آجل') {
                    // حفظ كفاتورة آجلة
                    sale.remainingAmount = sale.total; // المبلغ المتبقي يساوي الإجمالي في البداية
                    await dbInstance.addCreditSale(sale);
                    
                    alert('تم إتمام البيع الآجل بنجاح');
                } else {
                    // حفظ كفاتورة عادية
                    await dbInstance.addSale(sale);
                    
                    // طباعة الفاتورة
                    printInvoice(sale);
                    
                    alert('تم إتمام البيع بنجاح وتمت طباعة الفاتورة');
                }
                
                // مسح السلة وإعادة التحميل
                document.getElementById('cart-items').innerHTML = '';
                document.getElementById('empty-cart-message').style.display = 'block';
                document.getElementById('cart-total').textContent = '0 ريال';
                document.getElementById('discount-value').value = '0';
                document.getElementById('discount-amount').textContent = '0 ريال';
                document.getElementById('customer-name').value = '';
                document.getElementById('customer-section').style.display = 'none';
                document.getElementById('cashPayment').checked = true;
                
                // إعادة تحميل المنتجات المتاحة
                loadAvailableProducts();
            } catch (error) {
                console.error('خطأ في حفظ عملية البيع:', error);
                alert('حدث خطأ أثناء حفظ عملية البيع');
            }
        });

        // طباعة الفاتورة
        function printInvoice(sale) {
            // في تطبيق حقيقي، يمكن استخدام مكتبة مثل jsPDF لإنشاء PDF
            // هنا سنقوم بطباعة بسيطة للبيانات في نافذة جديدة
            
            let invoiceContent = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>فاتورة ${sale.invoiceNumber}</title>
                    <style>
                        body { font-family: 'Cairo', Tahoma, sans-serif; padding: 20px; }
                        .invoice-header { text-align: center; margin-bottom: 20px; }
                        .invoice-details { margin-bottom: 20px; }
                        .invoice-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        .invoice-table th, .invoice-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                        .invoice-table th { background-color: #4e73df; color: white; }
                        .invoice-total { text-align: left; font-weight: bold; }
                        .invoice-footer { margin-top: 30px; text-align: center; }
                    </style>
                </head>
                <body>
                    <div class="invoice-header">
                        <h1>${document.getElementById('store-name').textContent}</h1>
                        <h2>فاتورة مبيعات</h2>
                    </div>
                    
                    <div class="invoice-details">
                        <p><strong>رقم الفاتورة:</strong> ${sale.invoiceNumber}</p>
                        <p><strong>التاريخ:</strong> ${sale.date}</p>
                        <p><strong>طريقة الدفع:</strong> ${sale.paymentMethod}</p>
                    </div>
                    
                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th>اسم المنتج</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sale.items.forEach(item => {
                invoiceContent += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.price.toLocaleString()} ريال</td>
                        <td>${(item.quantity * item.price).toLocaleString()} ريال</td>
                    </tr>
                `;
            });
            
            invoiceContent += `
                        </tbody>
                    </table>
                    
                    <div class="invoice-total">
                        ${sale.discount > 0 ? `
                            <p>الإجمالي قبل الخصم: ${(sale.total + sale.discount).toLocaleString()} ريال</p>
                            <p>الخصم: ${sale.discount.toLocaleString()} ريال</p>
                        ` : ''}
                        <p>المبلغ الإجمالي: ${sale.total.toLocaleString()} ريال</p>
                    </div>
                    
                    <div class="invoice-footer">
                        <p>شكراً لشرائكم من متجرنا</p>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(invoiceContent);
            printWindow.document.close();
            printWindow.print();
        }

        // فتح ماسح الباركود
        document.getElementById('barcode-btn').addEventListener('click', async function() {
            const scanner = document.getElementById('barcode-scanner');
            scanner.classList.add('active');
            
            const codeReader = new ZXing.BrowserMultiFormatReader();
            
            codeReader.listVideoInputDevices()
                .then((videoInputDevices) => {
                    if (videoInputDevices.length > 0) {
                        const selectedDeviceId = videoInputDevices[0].deviceId;
                        
                        codeReader.decodeFromVideoDevice(selectedDeviceId, 'barcode-video', async (result, err) => {
                            if (result) {
                                // تم مسح الباركود بنجاح
                                codeReader.reset();
                                closeBarcodeScanner();
                                
                                // البحث عن المنتج باستخدام الباركود
                                const barcode = result.text;
                                try {
                                    const products = await dbInstance.getProducts();
                                    const product = products.find(p => p.barcode === barcode);
                                    
                                    if (product) {
                                        addToCart(product);
                                    } else {
                                        alert('لم يتم العثور على منتج بهذا الباركود');
                                    }
                                } catch (error) {
                                    console.error('خطأ في البحث عن المنتج:', error);
                                    alert('حدث خطأ أثناء البحث عن المنتج');
                                }
                            }
                            
                            if (err && !(err instanceof ZXing.NotFoundException)) {
                                console.error(err);
                            }
                        });
                    } else {
                        alert('لا توجد كاميرا متاحة');
                        closeBarcodeScanner();
                    }
                })
                .catch((err) => {
                    console.error(err);
                    alert('حدث خطأ أثناء الوصول إلى الكاميرا');
                    closeBarcodeScanner();
                });
        });

        // إغلاق ماسح الباركود
        document.getElementById('close-scanner-btn').addEventListener('click', function() {
            closeBarcodeScanner();
        });

        function closeBarcodeScanner() {
            const scanner = document.getElementById('barcode-scanner');
            scanner.classList.remove('active');
            
            // إيقاف الكاميرا
            const video = document.getElementById('barcode-video');
            if (video.srcObject) {
                const tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        // البحث في المنتجات لنقطة البيع
        document.getElementById('pos-product-search').addEventListener('input', async function() {
            const searchTerm = this.value.toLowerCase();
            try {
                const products = await dbInstance.getProducts();
                const availableProductsDiv = document.getElementById('available-products');
                availableProductsDiv.innerHTML = '';
                
                const filteredProducts = products.filter(product => 
                    product.quantity > 0 && (
                        product.name.toLowerCase().includes(searchTerm) || 
                        product.category.toLowerCase().includes(searchTerm) ||
                        (product.barcode && product.barcode.includes(searchTerm))
                    )
                );
                
                if (filteredProducts.length === 0) {
                    availableProductsDiv.innerHTML = '<p class="text-center text-muted">لا توجد منتجات تطابق البحث</p>';
                    return;
                }
                
                filteredProducts.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-item cursor-pointer';
                    productCard.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <img src="${product.image || 'https://via.placeholder.com/40'}" class="product-image me-2" alt="${product.name}">
                                <div>
                                    <h6 class="mb-0">${product.name}</h6>
                                    <small class="text-muted">${product.price.toLocaleString()} ريال</small>
                                </div>
                            </div>
                            <span class="badge bg-primary">${product.quantity} متوفر</span>
                        </div>
                    `;
                    
                    productCard.addEventListener('click', function() {
                        addToCart(product);
                        // مسح شريط البحث بعد الإضافة
                        document.getElementById('pos-product-search').value = '';
                        // إعادة تحميل قائمة المنتجات المتاحة
                        loadAvailableProducts();
                    });
                    
                    availableProductsDiv.appendChild(productCard);
                });
            } catch (error) {
                console.error('خطأ في البحث عن المنتجات:', error);
            }
        });

        // تحميل البيانات عند فتح الصفحة
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await initDatabase();
                loadAvailableProducts();
                
                // تحميل إعدادات المتجر
                const settings = await dbInstance.getSettings();
                document.getElementById('store-name').textContent = settings.storeName || 'متجري';
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
            }
        });
    </script>
</body>
</html>
